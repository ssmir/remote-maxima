# Контейнер C++ сервисов для IARnet2 (IARnet-Ice) #

## ВВЕДЕНИЕ ##
Данный контейнер обеспечивает интеграцию сервисов, разработанных на языке C++,
в среду распределенных вычислений IARnet2. Иногда мы будем называть данный
контейнер узлом. Возможности контейнера:
  * Поддержка InfoService: регистрация при запуске сервиса, отмена регистрации при останове сервиса.
  * Поддержка сервисов авторизации IARnet2:
    1. Сервисы авторизации должны быть запущены в отдельном Java контейнере.
    1. Поддержка авторизации при помощи пароля.
    1. Поддержка авторизации на основе SSL сертификата клиента.
  * Сервисы предствлены как отдельные модули (динамически загружаемые библиотеки)
  * Конфигурируемый порядок запуска сервисов.

Проблемы:
  * Ответы сервиса авторизации кэшируются навсегда (на время жизни процесса контейнера).
  * Нету ServantReaper, уничтожающего неиспользуемые объекты.
  * Сервант не получает имя клиента (Request.ClientId), вызвавшего операцию (особенность реализации Ice для C++: ServantLocator получает const Current).
  * Нельзя ограничить доступ к объекту определенной группой клиентов (allowed clients).
  * Для обновления библиотеки сервиса необходим перезапуск всего контейнера.
  * Отсутствие интерфейса управления контейнером.


## СБОРКА ##
Необходимые библиотеки:
  * Ice >= 3.2.0 (http://zeroc.com/download.html)
  * Boost >= 1.34.1 (компилировать не нужно) (http://www.boost.org)
  * (опционально) IcePython >= 3.2.0 (для запуска тестового клиента) (http://zeroc.com/download.html)

### СБОРКА ПОД WINDOWS ###
Требования:
  * Необходимо использовать MS Visual C++ 2005 и выше с установленным Platform SDK (или Windows SDK)
  * в ОС: переменная ICE\_HOME должна указывать на корень инсталяции Ice
  * в MS VC++: папка с заголовочными файлами Boost должна быть добавлена в число папок, содержащих заголовочные файлы

Продолжение следует...


### СБОРКА ПОД UNIX ###
Необходимые переменные окружения:
  * BOOST\_HOME должна указавать на корень инсталяции Boost
  * ICE\_HOME должна указывать на корень инсталяции Ice
  * (DY)LD\_LIBRARY\_PATH должна содержать $ICE\_HOME/lib

Сборка:
```
make -C src
```

Тестирование:
Сначала на dcs.isa.ru сделать следующее (запуск сервисов авторизации
и информационного сервиса):
```
cd /opt/iarnet2/iarnet2-cpp/maxima-service-demo/
./start_auth.sh &
./start_info.sh
```

Затем на локальной машине (запуск и тестирование узла):
```
cd ./bin
./node --Ice.Config=../conf/node.conf &
./client.py '<Proxy, напечатанная контейнером>'
```

## КОНФИГУРИРОВАНИЕ ##
Смотреть комментарии в примере конфигурационного файла узла ./conf/node.conf

Информационный сервис должен быть запущен отдельно в Java-узле, а ссылка
на информационный сервис должна быть добавлена в конфигурационный файл
конфигурируемого узла.

Сервисы авторизации должны быть запущены в отдельном контейнере IceBox, а их
Proxy необходимо добавить в конфигурационный файл конфигурируемого узла.


## РАЗРАБОТКА СЕРВИСОВ ##
Для создания сервиса необходимо сделать динимически загружаемую библиотеку,
содержащую код сервиса, а также точку входа (функцию, экспортируемую
библиотекой), обладающую определенной сигнатурой. Сначала опишем свойства точки
доступа, и интерфейс взаимодействия сервиса с узлом. Затем опишем как должен
выглядеть класс сервиса.

Объявление точки входа должно иметь следующий вид:
```
extern "C"
Ice::Object *createSimpleService(const IARnet::Node::ServiceContext &context);
```
Здесь createSimpleService - произвольное имя точки доступа. Данная функция
должна создавать в куче экземпляр сервиса и возвращать его. context содержит
параметры переданные сервису через конфигурационный файл, а также интерфейс
для взаимодействия с узлов (например, возможности создания/удаления объектов).

```
IARnet::Node::ServiceContext
```
Это класс, объекты которого позволяют сервису активно взаимодействовать с узлом.
Ссылка на объект данного класса передается точке входа сервиса. Если сервис
планирует вдальнейшем использовать данный объект, то следует сохранить его копию
в конструкторе сервиса.

Продолжение следует...

## FAQ ##
### Как узнать, какие сервисы были зарегистрированы данным узлом в информационном сервисе? ###
Ответ: Пусть информационный сервис запущен в java узле, с web-интерфейсом,
принимающим подключения только на http://localhost:17273. Тогда на хосте с
информационным сервисом необходимо запустить браузер и открыть в нем страницу
http://localhost:17273/services/InfoService

### Как настроить авторизацию по SSL сертификату клиента? ###
Ответ: Опишем довольно простой способ: Все узлы (серверы) и клиенты в системе
хранят один, общий для всех, self signed сертификат, используемый в качестве
сертификата CA. Этот сертификат используется для подписи личных сертификатов
серверов и клиентов. Свои личные сертификаты серверы и клиенты используют для
шифрования, идентификации, авторизации, а сертификат CA они используют для
проверки подлинности друг друга. Все серверы имеют один и тот же личный
сертификат, т.к. узлы друг от друга отличать не обязательно, достаточно проверки
подлинности, обеспечиваемой общим сертификатом CA. Каждый клиент имеет свой
собственный личный сертификат, что обеспечивает возможность отличать клиентов
друг от друга, используя distinguished name владельца сертификата (клиента).

В IARnet2 для авторизации по SSL сертификату используется SimpleSSLAuthService,
который разрешает или запрещает доступ клиенту лишь по его distinguished name.
То есть, для контроля доступа к различным областям одной системы, необходим
запуск сразу нескольких SimpleSSLAuthService.

На dcs.isa.ru можно найти пример более простой схемы: и клиенты и узлы
используют один и тот же личный сертификат и один SimpleSSLAuthService,
разрешающий доступ владельцу этого сертификата.
Запуск такого комплекса с одним узлом (на dcs.isa.ru):
```
cd /opt/iarnet2/iarnet2-cpp/maxima-service-demo

# Запустить сервисы авторизации:
./start_auth.sh &

# Запустить информационный сервис:
./start_info.sh &

# Запустить узел:
./start_node.sh

# Запустить клиента:
./start_client.sh

# Остановить узел:
./stop_node.sh
```

Настройки узла можно найти в master.conf, настройки клиента в client.conf,
список сертификатов, которым дан доступ в систему: java-services/config/trusted

### Как работает авторизация в IARnet2? ###
Ответ: По порядку:
  * При отсутствии прокси обоих сервисов авторизации доступ всегда разрешается.
  * Если клиент передает IARnet.User и IARnet.Password, то будет применена простая авторизация (MD5AuthService)
  * Иначе, если используется соединение по SSL и клиент имеет собственный сертификат, то идет авторизация по сертификату (SimpleSSLAuthService)
  * Иначе идет обычная авторизация (MD5AuthService) с User=anonymous Pass=